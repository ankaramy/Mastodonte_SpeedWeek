# User Portal — PRD (IFCore) — MVP

## Overview (Revised per Team B feedback)
A lightweight authentication system for IFCore enabling sign up, login, logout, and profile management. This is a **foundation feature** that unblocks all other teams by providing `useSession()` hooks and role-based access.

**Scope:** Signup → Login → Profile page only. **Duration:** 4–6 hours (not 4 weeks).

Uses:
- **Frontend:** Cloudflare Pages (TanStack Router, Zustand)
- **Auth backend:** Cloudflare Worker with **Better Auth** (replaces manual auth implementation)
- **Database:** D1 (Better Auth creates its own tables; does NOT modify existing `users` table)
- **Email/Stripe/TOTP:** Cut from MVP (post-launch features)

## Users & Roles (Simplified)
- **All users**: sign up with email + password, log in, view profile, log out.
- **Role model**: `role: "member"` (default) or `role: "captain"` (admins). Simple, not four-role RBAC.

## Goals
1. **Unblock all other teams** by providing `useSession()` React hook and persistent session state.
2. Ship a working login/signup flow in < 6 hours using Better Auth (not custom hashing/session logic).
3. Integrate with D1 and Cloudflare Workers following IFCore architecture.
4. Respect existing `users` table schema — use Better Auth's default tables instead.

## MVP Scope (Shippable in 1 day)

1. **Sign up** — email + password. Create user in Better Auth's `user` table.
2. **Log in** — email + password. Session cookie set by Worker.
3. **Log out** — clear session, redirect to home.
4. **Profile page** — show current user's name and email. Link to logout.
5. **Navigation** — show "Log in" if unauthenticated, show user name + "Profile" link if authenticated.
6. **RBAC enforcement** — each user has `role: "member"` or `"captain"` (stored in Better Auth's user table).

### NOT in MVP (cut for later)
- Email verification
- Password reset
- Stripe billing / subscription management
- 2FA / TOTP
- Support ticketing
- Account deletion
- API key management
- Onboarding questionnaire
- T&Cs flow (optional: can add with a checkbox, but no signing logic)
- Support ticket system

## Data Model (Better Auth defaults + minimal custom fields)

Better Auth creates these tables automatically:
- `user` — id, email, password (hashed with PBKDF2, NOT bcrypt), name, email_verified (boolean), image (optional), role (TEXT: "member" or "captain")
- `session` — session management (Better Auth handles this)
- `account` — OAuth/social login (not used in MVP)
- `verification` — email verification tokens (not used in MVP)

**Do NOT modify the existing `users` table.** It is used by other teams and the platform. Better Auth's `user` table is separate and additive.

## API Endpoints (Worker, via Better Auth)

All endpoints are auto-generated by Better Auth under `/api/auth/*`:
- `POST /api/auth/sign-up` — Create new user (email, password, name)
- `POST /api/auth/sign-in` — Log in (email, password) → returns session cookie
- `POST /api/auth/sign-out` — Log out → clear session cookie
- `GET /api/auth/session` — Get current session (for `useSession()` hook)

Other teams call `useSession()` to access the session state. No custom API design needed.

## UX Flows (simplified)

1. **Sign up** → Form (email, password, name) → POST /api/auth/sign-up → Session cookie set → Redirect to `/profile`
2. **Log in** → Form (email, password) → POST /api/auth/sign-in → Session cookie set → Redirect to `/profile`
3. **Log out** → POST /api/auth/sign-out → Clear cookie → Redirect to `/`
4. **Profile page** → Show user name, email. Link to logout.
5. **Nav bar** → If logged in, show name + "Profile" link. Else, show "Log In" link.

## Why Better Auth (not custom auth)

**Rule:** Do NOT use bcrypt for password hashing in Cloudflare Workers. Bcrypt exceeds the 10ms CPU limit and causes Error 1102. Better Auth handles this automatically with PBKDF2.

**Why not build custom auth:**
- Passwords: hashing, validation, salting (security-critical, weeks of testing).
- Sessions: cookie management, CSRF tokens, expiry, refresh logic.
- Database schema: user tables, session tables, verifications (tedious DDL).
- Cookies: HTTP-only, SameSite, Secure flags.

Better Auth does all of this in ~50 lines of config. Use it.

## Security & Compliance (simplified for MVP)

- **Passwords:** Better Auth uses PBKDF2 (works in Workers). Enforces strong passwords at signup.
- **Sessions:** HTTP-only, Secure, SameSite=Strict cookies managed by Better Auth.
- **CSRF:** Automatic via SameSite cookies.
- **Database tables:** Better Auth creates its own; does NOT touch existing `users` table.
- **Env variables:** BETTER_AUTH_SECRET and BETTER_AUTH_URL stored in Cloudflare secrets or `.dev.vars`.

## Monitoring & Alerts
- Not in MVP. Post-launch: monitor signup/login failure spikes, session errors, Worker errors via D1 logs.

## Edge Cases & Error Handling
- Invalid credentials: show error on login form.
- Password too weak: show validation error.
- Email already registered: show error on signup.
- Session expired: redirect to login.
- Database errors: log and show generic "something went wrong" message.

No complex retry logic, idempotency, or partial provisioning recovery needed for MVP.

## MVP (v1) — 4–6 hours, shippable feature

**Backend (2–3 hours)**
- Install Better Auth and configure for D1 + PBKDF2.
- Mount auth routes in Cloudflare Worker at `/api/auth/*`.
- Create D1 migration for Better Auth tables (`user`, `session`, `account`, `verification`).
- Ensure `run_worker_first: ["/api/*"]` in wrangler.jsonc so Worker intercepts requests.
- Set `BETTER_AUTH_SECRET` and `BETTER_AUTH_URL` environment variables.

**Frontend (2–3 hours)**
- Create `auth-client.ts` with `createAuthClient` and `useSession` hook.
- Build login page: email + password form, "Sign Up" button.
- Build signup page: email + password + name form.
- Build profile page: show user name, email, logout button.
- Update navbar: show login/logout state conditionally.
- Deploy to Cloudflare Pages.

**Testing (30 min)**
- Sign up with new email.
- Verify navbar shows your name.
- Log out and verify navbar changes.
- Log back in and verify profile page works.

## Acceptance Criteria
- Users can sign up with email + password and are logged in automatically.
- Users can log in with existing email + password.
- Users can log out and navbar reflects unauthenticated state.
- Profile page shows user name and email; only accessible when logged in.
- Session persists across page reloads (cookie-based).
- Better Auth tables created in D1 without modifying the existing `users` table.

## How This Unblocks Other Teams

Every other team uses `useSession()` to gate features and filter data:
```jsx
import { useSession } from '@/lib/auth-client'

export function Profile() {
  const { data: session } = useSession()
  if (!session) return <Redirect to="/login" />
  return <h1>Welcome {session.user.name}</h1>
}
```

You ship login/signup/profile. Other teams ship the dashboard, 3D viewer, report generator. Together = complete product.

## Next Steps / Deliverables
1. Review this MVP scope and approve (should take ~1 hour, not 4 weeks).
2. Scaffold Cloudflare Worker Better Auth config (use the Cloudflare skill blueprint).
3. Create frontend components (LoginPage, SignupPage, ProfilePage).
4. Deploy to staging and test end-to-end.
5. Do quick RBAC test (ensure captain role is stored/retrieved).
6. Deploy to production.

## Post-Launch Roadmap (out of scope for MVP)
- Email verification and password reset
- Stripe billing + subscription management
- 2FA / TOTP
- Support ticket system
- Account deletion with retention window
- Team invite / member management
- API key generation and rotation
